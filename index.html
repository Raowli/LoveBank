<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>LoveBank Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #ff4d6d; --bg: #fff5f7; --husband: #4a90e2; --wife: #9b51e0; --danger: #ff4444; }
        body { font-family: -apple-system, system-ui; background: var(--bg); margin: 0; padding: 15px; color: #333; padding-bottom: 80px; }
        .card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .score { font-size: 54px; font-weight: bold; color: var(--primary); text-align: center; margin: 5px 0; }
        
        /* Stats Styles */
        .stats-row { display: flex; justify-content: space-around; text-align: center; margin-top: 10px; }
        .stat-box { flex: 1; }
        .stat-val { display: block; font-size: 20px; font-weight: bold; color: var(--primary); }
        .stat-lbl { font-size: 10px; color: #999; text-transform: uppercase; }

        .calendar-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0 15px 0; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .day-pill { background: white; padding: 10px 15px; border-radius: 15px; min-width: 60px; text-align: center; border: 1px solid #eee; flex-shrink: 0; cursor: pointer; }
        .day-pill.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        .user-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .user-btn { flex: 1; padding: 12px; border-radius: 12px; border: 2px solid #eee; background: white; font-weight: bold; }
        .user-btn.active.h { background: var(--husband); color: white; border-color: var(--husband); }
        .user-btn.active.w { background: var(--wife); color: white; border-color: var(--wife); }

        input { width: 100%; padding: 15px; margin: 8px 0; border: 1px solid #eee; border-radius: 15px; box-sizing: border-box; font-size: 16px; outline: none; }
        .manual-pts { display: flex; gap: 10px; margin-top: 5px; }
        .pt-btn { flex: 1; padding: 12px 5px; border-radius: 12px; border: 1px solid var(--primary); color: var(--primary); background: white; font-weight: bold; }

        .tabs { display: flex; background: #eee; border-radius: 20px; padding: 5px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 12px; border-radius: 15px; cursor: pointer; font-weight: bold; color: #666; font-size: 14px; }
        .tab.active { background: white; color: var(--primary); }

        .log-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px; border-left: 6px solid #eee; }
        .log-item.h { border-left-color: var(--husband); }
        .log-item.w { border-left-color: var(--wife); }
        
        .alert-banner { background: #ffe5ec; color: var(--primary); padding: 10px; border-radius: 15px; text-align: center; font-size: 12px; margin-bottom: 15px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="notif-banner" class="alert-banner" onclick="enableNotifs()">üîî Tap to Enable Partner Alerts</div>

    <div class="card">
        <div style="text-align:center; font-size:11px; color:var(--primary); font-weight:bold;">TOTAL BALANCE</div>
        <div id="balance" class="score">0</div>
        
        <div class="stats-row">
            <div class="stat-box">
                <span id="stat-week" class="stat-val">0</span>
                <span class="stat-lbl">This Week</span>
            </div>
            <div class="stat-box" style="border-left: 1px solid #eee; border-right: 1px solid #eee;">
                <span id="stat-month" class="stat-val">0</span>
                <span class="stat-lbl">This Month</span>
            </div>
        </div>
    </div>

    <div class="calendar-bar" id="calendar"></div>

    <div class="tabs">
        <div class="tab active" id="tab-acts" onclick="switchView('acts')">Activity</div>
        <div class="tab" id="tab-shop" onclick="switchView('shop')">Rewards</div>
    </div>

    <div id="view-acts">
        <div class="card">
            <div class="user-selector">
                <button id="btn-h" class="user-btn active h" onclick="setUser('Husband')">Husband</button>
                <button id="btn-w" class="user-btn w" onclick="setUser('Wife')">Wife</button>
            </div>
            <input type="text" id="note" placeholder="What happened?">
            <div class="manual-pts">
                <input type="number" id="custom-pts" style="flex:1" placeholder="Pts">
                <button class="pt-btn" onclick="addAct(null)" style="background:var(--primary); color:white">Save Act</button>
            </div>
        </div>
        <div id="logs"></div>
    </div>

    <div id="view-shop" class="hidden">
        <div class="card" onclick="redeem('Massage', 100)">ü¶∂ Massage (100 pts)</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zqcevjiowfcghtcjnzex.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxY2V2amlvd2ZjZ2h0Y2puemV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODY3MzAsImV4cCI6MjA4MzM2MjczMH0.mkUS7Q8JMhFtJGFZ0_ceK7bVLdYyX9uMbPr3SBIWxBo';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = 'Husband';
        let currentBalance = 0;
        let selectedDay = new Date().toLocaleDateString();
        let lastId = null;

        function enableNotifs() {
            Notification.requestPermission().then(perm => {
                if(perm === 'granted') document.getElementById('notif-banner').classList.add('hidden');
            });
        }

        async function loadData() {
            const { data, error } = await sb.from('lovebank').select('*').order('created_at', { ascending: false });
            if (error) return;

            let total = 0, weekTotal = 0, monthTotal = 0, html = '';
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            data.forEach((item, index) => {
                const itemDate = new Date(item.created_at);
                if (item.status === 'approved') {
                    total += item.points;
                    if (itemDate >= startOfWeek) weekTotal += item.points;
                    if (itemDate >= startOfMonth) monthTotal += item.points;
                }

                // Alert logic: If the latest item is new and from the partner
                if (index === 0 && lastId && item.id !== lastId && item.user_type !== currentUser) {
                    new Notification("New Act Added!", { body: `${item.user_type} added: ${item.act} (${item.points} pts)` });
                }
                if (index === 0) lastId = item.id;

                if (itemDate.toLocaleDateString() === selectedDay) {
                    const userClass = item.user_type === 'Husband' ? 'h' : 'w';
                    html += `<div class="log-item ${userClass}">
                        <div><small>${itemDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ‚Ä¢ ${item.user_type}</small><br><b>${item.act}</b></div>
                        <div style="display:flex; align-items:center; gap:10px">
                            ${item.status === 'pending' ? `<button class="pt-btn" onclick="approve('${item.id}')">Confirm</button>` : `<b>${item.points > 0 ? '+' : ''}${item.points}</b>`}
                            <span onclick="deleteAct('${item.id}')">üóëÔ∏è</span>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('balance').innerText = total;
            document.getElementById('stat-week').innerText = weekTotal;
            document.getElementById('stat-month').innerText = monthTotal;
            document.getElementById('logs').innerHTML = html || '<div style="text-align:center;color:#999;padding:20px;">No acts today</div>';
            currentBalance = total;
        }

        async function addAct(fixedPts) {
            const pts = fixedPts || parseInt(document.getElementById('custom-pts').value);
            const act = document.getElementById('note').value || "Good Deed";
            if(isNaN(pts)) return alert("Enter points!");
            await sb.from('lovebank').insert([{ act, points: pts, status: 'pending', user_type: currentUser }]);
            document.getElementById('note').value = '';
            document.getElementById('custom-pts').value = '';
            loadData();
        }

        async function approve(id) { await sb.from('lovebank').update({ status: 'approved' }).eq('id', id); loadData(); }
        async function deleteAct(id) { if(confirm("Delete?")) { await sb.from('lovebank').delete().eq('id', id); loadData(); } }
        
        function setUser(u) { 
            currentUser = u; 
            document.getElementById('btn-h').classList.toggle('active', u === 'Husband');
            document.getElementById('btn-w').classList.toggle('active', u === 'Wife');
        }

        function switchView(v) {
            document.getElementById('view-acts').classList.toggle('hidden', v !== 'acts');
            document.getElementById('view-shop').classList.toggle('hidden', v !== 'shop');
            document.getElementById('tab-acts').classList.toggle('active', v === 'acts');
            document.getElementById('tab-shop').classList.toggle('active', v === 'shop');
        }

        // Init Calendar bar
        const cal = document.getElementById('calendar');
        for (let i = 0; i < 7; i++) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const pill = document.createElement('div');
            pill.className = `day-pill ${d.toLocaleDateString() === selectedDay ? 'active' : ''}`;
            pill.innerHTML = `<span style="font-size:10px;display:block">${d.toLocaleDateString('en-US',{weekday:'short'})}</span>${d.getDate()}`;
            pill.onclick = () => { selectedDay = d.toLocaleDateString(); loadData(); };
            cal.appendChild(pill);
        }

        setInterval(loadData, 5000);
        loadData();
    </script>
</body>
</html>
